# This File is automatically synchronized from https://github.com/Glatzel/template

lefthook: pixi run --no-progress --manifest-path ./lefthook/pixi.toml lefthook

templates:
  run: run --no-progress --manifest-path ./lefthook/pixi.toml

colors: true

output:
  - meta # Print lefthook version
  - summary # Print summary block (successful and failed steps)
  - empty_summary # Print summary heading when there are no steps to run
  # - success # Print successful steps
  - failure # Print failed steps printing
  # - execution # Print any execution logs
  # - execution_out # Print execution output
  # - execution_info # Print `EXECUTE > ...` logging
  - skips # Print "skip" (i.e. no files matched)

glob_matcher: doublestar

pre-commit:
  jobs:
    - name: pre-commit-hook
      exclude:
        - "**/external/**"
      stage_fixed: true
      group:
        jobs:
          - name: check-json
            glob: "**/*.json"
            run: pixi {run} check-json {staged_files}
          - name: check-toml
            glob: "**/*.toml"
            run: pixi {run} check-toml {staged_files}
          - name: check-yaml
            glob: "**/*.yaml"
            run: pixi {run} check-yaml {staged_files}
          - name: check-xml
            glob: "**/*.xml"
            run: pixi {run} check-xml {staged_files}
          - name: end-of-file-fixer
            run: pixi {run} end-of-file-fixer {staged_files}
          - name: trailing-whitespace-fixer
            run: pixi {run} trailing-whitespace-fixer {staged_files}

    - name: misc
      stage_fixed: true
      exclude:
        - "**/external/**"
      group:
        jobs:
          - name: taplo
            glob: "**/*.toml"
            env:
              RUST_LOG: warn
            run: taplo format -o 'reorder_keys=true'

          - name: actionlint
            glob: ".github/workflows/*.yml"
            run: actionlint {staged_files}

          - name: typos
            run: typos --force-exclude {staged_files}

          - name: markdown
            exclude:
              - changelog.md
              - CHANGELOG.md
            glob: "**/*.md"
            run: markdownlint-cli2 --fix {staged_files}

    - name: csharp
      stage_fixed: true
      exclude:
        - "**/external/**"
      glob: "**/*.csproj"
      group:
        jobs:
          - name: dotnet format
            run: dotnet format
          - name: csharpier
            run: dotnet tool install -g csharpier; csharpier format .; csharpier check .

    - name: python
      glob: "**/*.{py,pyi}"
      exclude:
        - "**external/**"
      stage_fixed: true
      group:
        jobs:
          - name: ruff lint
            run: ruff check --fix --show-fixes --exit-non-zero-on-fix --force-exclude {staged_files}
          - name: ruff format
            run: ruff format --force-exclude --exit-non-zero-on-format {staged_files}
          - name: numpydoc
            run: numpydoc lint {staged_files} --ignore ES01 EX01 GL08 PR04 RT03 SA01 SA04

    - name: rust
      stage_fixed: true
      exclude:
        - "**/target/**/Cargo.toml"
        - "**/crates/**/Cargo.toml"
        - "**/external/**"
      glob: "**/Cargo.toml"
      group:
        jobs:
          - name: cargo-machete
            run: |
              pwsh -CommandWithArgs '''
              $ErrorActionPreference = \"Stop\"
              $PSNativeCommandUseErrorActionPreference = $true;
              $ROOT = git rev-parse --show-toplevel;
              foreach ($file in $args) {
                  Set-Location (Split-Path (Resolve-Path $file) -Parent)
                  Write-Output \"Cargo machete in: $pwd\"
                  cargo machete
                  Set-Location $ROOT
              }''' {staged_files}

          - name: cargo-clippy
            run: |
              pwsh -CommandWithArgs '''
              $ErrorActionPreference = \"Stop\"
              $PSNativeCommandUseErrorActionPreference = $true;
              $ROOT = git rev-parse --show-toplevel;
              if ($env:CI) {
                  rustup toolchain install stable --profile=minimal
                  rustup component add clippy --toolchain stable
              }
              foreach ($file in $args) {
                  $dir = (Split-Path (Resolve-Path $file) -Parent)
                  Set-Location $dir
                  Write-Output \"Cargo clippy in: $pwd\"
                  if (Test-Path ./scripts/setup.ps1) {
                      &./scripts/setup.ps1
                      Set-Location $dir
                  }
                  cargo +stable clippy --fix --all-features --quiet
                  cargo +stable clippy --all-features --quiet -- -Dwarnings
                  Set-Location $ROOT
              }
              ''' {staged_files}

          - name: cargo-fmt
            run: |
              pwsh -CommandWithArgs '''
              $ErrorActionPreference = \"Stop\"
              $PSNativeCommandUseErrorActionPreference = $true;
              $ROOT = git rev-parse --show-toplevel;
              if ($env:CI) {
                  rustup toolchain install nightly --profile=minimal
                  rustup component add rustfmt --toolchain nightly
              }
              foreach ($file in $args) {
                  Set-Location (Split-Path (Resolve-Path $file) -Parent)
                  Write-Output \"Cargo fmt in: $pwd\"
                  cargo +nightly fmt --all --quiet
                  Set-Location $ROOT
              }
              ''' {staged_files}
